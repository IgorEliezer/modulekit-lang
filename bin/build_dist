#!/usr/bin/php
<?php @include "conf.php"; /* load a local configuration */ ?>
<?php include "modulekit/loader.php"; /* loads all php-includes */ ?>
<?php
call_hooks('init');
@mkdir('dist');

$d = opendir('dist');
while ($f = readdir($d)) {
  if (preg_match("/^lang_(.*)\.(data|js|json)$/", $f)) {
    unlink("dist/{$f}");
  }
}
closedir($d);

if (!isset($languages)) {
  $tmp = $language_list;
  unset($tmp['']);

  $languages = array_keys($tmp);
}

foreach($languages as $lang) {
  $lang_str=array();

  print "* Building dist file for language '$lang'\n";

  lang_update_cache('dist/', $lang);
}

print "* Writing lang_list file\n";

$file = "dist/lang_list";
$data = array(
  "languages" => $languages,
  "language_list" => $language_list,
);
file_put_contents("{$file}.data", serialize($data));
file_put_contents("{$file}.js",
  "var languages=" . json_encode($languages, JSON_UNESCAPED_SLASHES) . ";" .
  "var language_list=" . json_encode($language_list, JSON_FORCE_OBJECT|JSON_UNESCAPED_SLASHES) . ";"
);
file_put_contents("{$file}.json", json_encode($data, JSON_UNESCAPED_SLASHES|JSON_UNESCAPED_UNICODE));
